<div class="assign-task">
    <form [formGroup]="assignTaskForm" class="assign-task-form">
        <h2 class="text-2xl text-primary px-4 pt-4">Assign task</h2>
        <div class="border-b-2 border-primary pb-4">
            <div class="">
                <div class="flex gap-2 p-4 items-center">
                    <mat-form-field appearance="fill" class="w-full">
                        <mat-label>Title</mat-label>
                        <input matInput placeholder="Enter task title" formControlName="title" />
                        <mat-error
                            *ngIf="assignTaskForm.get('title')?.invalid && assignTaskForm.get('title')?.touched">
                            Title is required
                        </mat-error>
                    </mat-form-field>

                    <!-- Description -->
                    <mat-form-field appearance="fill" class="w-full">
                        <mat-label>Description</mat-label>
                        <textarea matInput placeholder="Enter task description" formControlName="description"
                            rows="1"></textarea>
                        <mat-error
                            *ngIf="assignTaskForm.get('description')?.invalid && assignTaskForm.get('description')?.touched">
                            Description is required
                        </mat-error>
                    </mat-form-field>
                    <mat-form-field appearance="fill" class="min-w-50">
                        <mat-label>Date</mat-label>
                        <input matInput placeholder="Select Date" [matDatepicker]="picker" [min]="minDate"
                            formControlName="date" />
                        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker></mat-datepicker>
                        <mat-error *ngIf="assignTaskForm.get('date')?.invalid && assignTaskForm.get('date')?.touched">
                            Date is required
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field class="min-w-50">
                        <mat-label>Module</mat-label>
                        <mat-select placeholder="Select Module" formControlName="module">
                            <mat-option value="Video">Video</mat-option>
                            <mat-option value="QBank">QBank</mat-option>
                            <mat-option value="Test">Test</mat-option>
                        </mat-select>
                        <mat-error
                            *ngIf="assignTaskForm.get('module')?.invalid && assignTaskForm.get('module')?.touched">
                            Module is required
                        </mat-error>
                    </mat-form-field>

                    <div class="flex gap-2 justify-end items-center">
                        <div class="px-2">
                        <div class="flex flex-col items-center gap-2 mt-2 justify-center">
                            <span *ngIf="assignTaskForm.get('students')?.invalid && assignTaskForm.get('students')?.touched"
                                class="text-red-500 text-sm text-center">
                                At least one student is required
                            </span>
                            <span *ngIf="assignTaskForm.get('students')?.value?.length > 0" class="text-green-600 text-sm text-center">
                                {{ assignTaskForm.get('students')?.value.length }} student(s) selected
                            </span>
                        </div>
                        <button mat-raised-button type="button" (click)="assignStudent()">Assign Students</button>
                    </div>
                        <div><button mat-raised-button type="submit" (click)="assignTask()">Assign Task</button></div>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- VIDEO MODULE -->
        <div *ngIf="assignTaskForm.get('module')?.value === 'Video'" class="grid grid-cols-6 h-[85vh]">
            <div class="chapter-selection p-4 border-r-2 border-primary overflow-scroll">
                <h2 class="text-xl font-semibold pb-2">Subject</h2>

                <!-- Selected Video Subjects Display -->
                <div *ngIf="getSelectedVideoSubjects().length > 0" class="selected-items mb-4">
                    <h4 class="text-sm font-medium mb-2">Selected ({{ getSelectedVideoSubjects().length }}):</h4>
                    <div class="selected-chips">
                        <mat-chip-listbox>
                            <mat-chip-option *ngFor="let subject of getSelectedVideoSubjects()"
                                (removed)="removeVideoSubject(subject)" removable="true" class="selected-chip">
                                {{ subject.subjectName }}
                                <mat-icon matChipRemove>cancel</mat-icon>
                            </mat-chip-option>
                        </mat-chip-listbox>
                    </div>
                </div>

                <div class="flex gap-2 flex-col">
                    <h2 *ngIf="videoSubjects?.length <= 0">No Data Found</h2>
                    <div *ngFor="let subject of videoSubjects" class="list-item"
                        [class.selected]="isVideoSubjectSelected(subject)"
                        [class.multi-selected]="isVideoSubjectSelected(subject)" (click)="selectVideoSubject(subject)">
                        <mat-icon *ngIf="isVideoSubjectSelected(subject)" class="selection-icon">check_circle</mat-icon>
                        <mat-icon *ngIf="!isVideoSubjectSelected(subject)"
                            class="selection-icon">radio_button_unchecked</mat-icon>
                        {{ subject.subjectName }}
                    </div>
                </div>
                <div *ngIf="assignTaskForm.get('videoSubjects')?.invalid && assignTaskForm.get('videoSubjects')?.touched"
                    class="text-red-500 mt-2">
                    At least one subject is required
                </div>
            </div>

            <div class="topic-selection p-4 col-span-5 overflow-scroll">
                <h2 class="font-semibold text-xl">Videos</h2>

                <!-- Selected Videos Display -->
                <div *ngIf="getSelectedVideos().length > 0" class="selected-items mb-4">
                    <h4 class="text-sm font-medium mb-2">Selected Videos ({{ getSelectedVideos().length }}):</h4>
                    <div class="selected-chips">
                        <mat-chip-listbox>
                            <mat-chip-option *ngFor="let video of getSelectedVideos()"
                                (removed)="removeVideo(video)" removable="true" class="selected-chip">
                                {{ video.title }}
                                <mat-icon matChipRemove>cancel</mat-icon>
                            </mat-chip-option>
                        </mat-chip-listbox>
                    </div>
                </div>

                <div class="pt-2">
                    <h2 *ngIf="videosByTopic?.length <= 0">No Data Found</h2>
                    <div *ngFor="let topic of videosByTopic">
                        <h2 class="p-2 font-semibold text-base mt-2">{{ topic.topic }}</h2>
                        <div class="grid grid-cols-3 gap-4">
                            <div *ngFor="let video of topic?.videos" class="list-item"
                                [class.selected]="isVideoSelected(video)"
                                [class.multi-selected]="isVideoSelected(video)"
                                (click)="selectVideo(video)">
                                <mat-icon *ngIf="isVideoSelected(video)"
                                    class="selection-icon">check_circle</mat-icon>
                                <mat-icon *ngIf="!isVideoSelected(video)"
                                    class="selection-icon">radio_button_unchecked</mat-icon>
                                {{ video.title }}<br><span class="text-sm">{{ video.duration || 'Duration not specified' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div *ngIf="assignTaskForm.get('videos')?.invalid && assignTaskForm.get('videos')?.touched"
                    class="text-red-500 mt-2">
                    At least one video is required
                </div>
            </div>
        </div>

        <!-- QBANK MODULE -->
        <div *ngIf="assignTaskForm.get('module')?.value === 'QBank'" class="grid grid-cols-6 h-[85vh]">
            <div class="chapter-selection p-4 border-r-2 border-primary overflow-scroll">
                <h2 class="text-xl font-semibold pb-2">Subject</h2>

                <!-- Selected Subjects Display -->
                <div *ngIf="getSelectedQbankSubjects().length > 0" class="selected-items mb-4">
                    <h4 class="text-sm font-medium mb-2">Selected ({{ getSelectedQbankSubjects().length }}):</h4>
                    <div class="selected-chips">
                        <mat-chip-listbox>
                            <mat-chip-option *ngFor="let subject of getSelectedQbankSubjects()"
                                (removed)="removeQbankSubject(subject)" removable="true" class="selected-chip">
                                {{ subject.subjectName }}
                                <mat-icon matChipRemove>cancel</mat-icon>
                            </mat-chip-option>
                        </mat-chip-listbox>
                    </div>
                </div>

                <div class="flex gap-2 flex-col">
                    <h2 *ngIf="subjects?.length <= 0">No Data Found</h2>
                    <div *ngFor="let subject of subjects" class="list-item"
                        [class.selected]="isQbankSubjectSelected(subject)"
                        [class.multi-selected]="isQbankSubjectSelected(subject)" (click)="selectqbankSubject(subject)">
                        <mat-icon *ngIf="isQbankSubjectSelected(subject)" class="selection-icon">check_circle</mat-icon>
                        <mat-icon *ngIf="!isQbankSubjectSelected(subject)"
                            class="selection-icon">radio_button_unchecked</mat-icon>
                        {{ subject.subjectName }}
                    </div>
                </div>
                <div *ngIf="assignTaskForm.get('qbankSubjects')?.invalid && assignTaskForm.get('qbankSubjects')?.touched"
                    class="text-red-500 mt-2">
                    At least one subject is required
                </div>
            </div>

            <div class="topic-selection p-4 col-span-5 overflow-scroll">
                <h2 class="font-semibold text-xl">Exams</h2>

                <!-- Selected Exams Display -->
                <div *ngIf="getSelectedQbankExams().length > 0" class="selected-items mb-4">
                    <h4 class="text-sm font-medium mb-2">Selected Exams ({{ getSelectedQbankExams().length }}):</h4>
                    <div class="selected-chips">
                        <mat-chip-listbox>
                            <mat-chip-option *ngFor="let exam of getSelectedQbankExams()"
                                (removed)="removeQbankExam(exam)" removable="true" class="selected-chip">
                                {{ exam.examName }}
                                <mat-icon matChipRemove>cancel</mat-icon>
                            </mat-chip-option>
                        </mat-chip-listbox>
                    </div>
                </div>

                <div class="pt-2">
                    <h2 *ngIf="qbankExams?.length <= 0">No Data Found</h2>
                    <div *ngFor="let topic of qbankExams">
                        <h2 class="p-2 font-semibold text-base mt-2">{{ topic.topicName }}</h2>
                        <div class="grid grid-cols-3 gap-4">
                            <div *ngFor="let qbankExam of topic?.exams" class="list-item"
                                [class.selected]="isQbankExamSelected(qbankExam)"
                                [class.multi-selected]="isQbankExamSelected(qbankExam)"
                                (click)="selectqbankExam(qbankExam)">
                                <mat-icon *ngIf="isQbankExamSelected(qbankExam)"
                                    class="selection-icon">check_circle</mat-icon>
                                <mat-icon *ngIf="!isQbankExamSelected(qbankExam)"
                                    class="selection-icon">radio_button_unchecked</mat-icon>
                                {{ qbankExam.examName }}<br><span class="text-sm">{{ qbankExam.numberOfQuestions }}
                                    Questions</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div *ngIf="assignTaskForm.get('qbankExams')?.invalid && assignTaskForm.get('qbankExams')?.touched"
                    class="text-red-500 mt-2">
                    At least one exam is required
                </div>
            </div>
        </div>

        <!-- TEST MODULE -->
        <div *ngIf="assignTaskForm.get('module')?.value === 'Test'" class="grid grid-cols-6 h-[85vh]">
            <div class="chapter-selection p-4 border-r-2 border-primary overflow-scroll">
                <h2 class="text-xl font-semibold pb-2">Exam Type</h2>

                <!-- Selected Exam Types Display -->
                <div *ngIf="getSelectedExamTypes().length > 0" class="selected-items mb-4">
                    <h4 class="text-sm font-medium mb-2">Selected ({{ getSelectedExamTypes().length }}):</h4>
                    <div class="selected-chips">
                        <mat-chip-listbox>
                            <mat-chip-option *ngFor="let examType of getSelectedExamTypes()"
                                (removed)="removeExamType(examType)" removable="true" class="selected-chip">
                                {{ examType.name }}
                                <mat-icon matChipRemove>cancel</mat-icon>
                            </mat-chip-option>
                        </mat-chip-listbox>
                    </div>
                </div>

                <div class="flex gap-2 flex-col">
                    <h2 *ngIf="examTypes?.length <= 0">No Data Found</h2>
                    <div *ngFor="let examType of examTypes" class="list-item"
                        [class.selected]="isExamTypeSelected(examType)"
                        [class.multi-selected]="isExamTypeSelected(examType)" (click)="selectexamType(examType)">
                        <mat-icon *ngIf="isExamTypeSelected(examType)" class="selection-icon">check_circle</mat-icon>
                        <mat-icon *ngIf="!isExamTypeSelected(examType)"
                            class="selection-icon">radio_button_unchecked</mat-icon>
                        {{ examType.name }}
                    </div>
                </div>
                <div *ngIf="assignTaskForm.get('examTypes')?.invalid && assignTaskForm.get('examTypes')?.touched"
                    class="text-red-500 mt-2">
                    At least one exam type is required
                </div>
            </div>

            <div class="topic-selection p-4 col-span-5 overflow-scroll">
                <h2 class="font-semibold text-xl">Exams</h2>

                <!-- Selected Test Exams Display -->
                <div *ngIf="getSelectedTestExams().length > 0" class="selected-items mb-4">
                    <h4 class="text-sm font-medium mb-2">Selected Exams ({{ getSelectedTestExams().length }}):</h4>
                    <div class="selected-chips">
                        <mat-chip-listbox>
                            <mat-chip-option *ngFor="let testExam of getSelectedTestExams()"
                                (removed)="removeTestExam(testExam)" removable="true" class="selected-chip">
                                {{ testExam.title }}
                                <mat-icon matChipRemove>cancel</mat-icon>
                            </mat-chip-option>
                        </mat-chip-listbox>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 pt-2">
                    <h2 *ngIf="testExamsByType?.length === 0">No Data Found</h2>
                        <div *ngFor="let exam of testExamsByType" class="list-item"
                          [class.selected]="isTestExamSelected(exam)"
                          [class.multi-selected]="isTestExamSelected(exam)"
                          (click)="selectTestExam(exam)">
                          <mat-icon *ngIf="isTestExamSelected(exam)" class="selection-icon">check_circle</mat-icon>
                          <mat-icon *ngIf="!isTestExamSelected(exam)" class="selection-icon">radio_button_unchecked</mat-icon>
                          {{ exam.title }}
                        </div>
                </div>
                <div *ngIf="assignTaskForm.get('testExams')?.invalid && assignTaskForm.get('testExams')?.touched"
                    class="text-red-500 mt-2">
                    At least one test exam is required
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Student Selection Popup -->
<ng-template #studentPopup>
    <div class="flex gap-2 justify-between items-center">
        <h2 class="text-xl font-semibold mb-4">Select Students</h2>
        <button mat-button (click)="dialogRef.close()"><mat-icon>close</mat-icon></button>
    </div>

    <div class="max-h-[400px] overflow-y-auto">
        <table mat-table [dataSource]="studentList" class="w-full">

            <!-- Checkbox Column -->
            <ng-container matColumnDef="select">
                <th mat-header-cell *matHeaderCellDef>
                    <mat-checkbox (change)="toggleAllStudents($event)" [checked]="isAllSelected()"
                        [indeterminate]="isIndeterminate()">
                    </mat-checkbox>
                </th>
                <td mat-cell *matCellDef="let student">
                    <mat-checkbox (change)="toggleStudent(student, $event)" [checked]="isStudentSelected(student)">
                    </mat-checkbox>
                </td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef> Student Name </th>
                <td mat-cell *matCellDef="let student"> {{student.firstName}} {{student.lastName}}</td>
            </ng-container>

            <ng-container matColumnDef="email">
                <th mat-header-cell *matHeaderCellDef> Email </th>
                <td mat-cell *matCellDef="let student"> {{student.email}} </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['select', 'name', 'email']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['select', 'name', 'email']"></tr>
        </table>
    </div>

    <!-- Paginator -->
    <mat-paginator [length]="totalStudents" [pageSize]="pageSize" [pageIndex]="pageNumber - 1"
        [pageSizeOptions]="[5, 10, 20]" (page)="onPageChange($event)">
    </mat-paginator>

    <div class="flex justify-end gap-2 mt-4">
        <!-- <button mat-button (click)="dialogRef.close()">Cancel</button>
      <button mat-raised-button color="primary" (click)="saveSelectedStudents()">Save</button> -->
    </div>
</ng-template>