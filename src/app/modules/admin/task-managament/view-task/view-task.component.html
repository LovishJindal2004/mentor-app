<!-- side-panel.component.html -->
<div class="side-panel-overlay" *ngIf="isOpen" (click)="onClose()"></div>

<div class="side-panel" [class.side-panel-open]="isOpen">
    <div class="min-h-screen bg-gray-900 text-gray-100 p-6 font-sans">
        <div class="max-w-6xl mx-auto h-full grid grid-cols-12 gap-6">

            <!-- Left: Task details -->
            <div class="col-span-7 bg-gray-950 rounded-lg shadow-lg p-6">

                <!-- Workspace & Title -->
                <div class="flex items-start justify-between">
                    <div>
                        <div class="text-sm text-gray-400">Task</div>
                        <h1 class="text-2xl font-semibold mt-2">{{ taskDetails?.title }}</h1>
                        <div class="text-xs text-gray-400">Created on: {{ taskDetails?.date | date:'MMM d, y' }}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="p-2 rounded-full hover:bg-gray-800" (click)="onClose()">
                            <span class="material-icons text-gray-300">close</span>
                        </button>
                    </div>
                </div>

                <div class="border-t border-gray-800 my-4"></div>

                <!-- Properties grid -->
                <div class="grid grid-cols-3 gap-6 mt-2">
                    <div>
                        <div class="text-sm text-gray-400">Status</div>
                        <div class="mt-2 font-medium">
                            {{ getStatusLabel(taskDetails?.status) }}
                        </div>
                    </div>

                    <!-- <div>
                        <div class="text-sm text-gray-400">Assignees</div>
                        <div class="mt-2 flex items-center gap-2 flex-wrap badges-group">
                            <div *ngFor="let person of taskDetails?.assignedTo | slice:0:3" class="flex items-center gap-2 badges">
                              <div class="w-7 h-7 rounded-full bg-green-600 text-white text-sm font-medium flex items-center justify-center">
                                {{ person.name[0] | uppercase }}
                              </div>
                            </div>
                          
                            <div *ngIf="taskDetails?.assignedTo?.length > 3"
                                 class="w-7 h-7 rounded-full bg-gray-500 ml-[-15px] text-white text-sm font-medium flex items-center justify-center">
                              +{{ taskDetails?.assignedTo?.length - 3 }}
                            </div>
                          </div>
                          
                    </div> -->
                </div>

                <div class="border-t border-gray-800 my-6"></div>

                <!-- Description -->
                <div *ngIf="_userdetails?.Roles != 'Mentor'">
                    <h3 class="flex items-center gap-2 text-sm text-gray-400">
                        <span class="material-icons text-base">description</span> Description
                    </h3>
                    <p class="mt-3 text-sm text-gray-300">{{ taskDetails?.description }}</p>
                </div>
                <div *ngIf="_userdetails?.Roles == 'Mentor'">
                    <h3 class="flex items-center gap-2 text-sm text-gray-400">
                      <span class="material-icons text-base">description</span> Description
                      <button 
                        class="ml-2 text-xs text-blue-400 hover:underline"
                        (click)="toggleEditDescription()">
                        {{ isEditingDescription ? 'Save' : 'Edit' }}
                      </button>
                    </h3>
                  
                    <!-- Show normal text -->
                    <p *ngIf="!isEditingDescription" class="mt-3 text-sm text-gray-300">
                      {{ taskDetails?.description || 'No description available' }}
                    </p>
                  
                    <!-- Show editable input -->
                    <textarea 
                      *ngIf="isEditingDescription"
                      [(ngModel)]="editableDescription"
                      rows="3"
                      class="mt-3 w-full text-sm text-white rounded-md p-2 outline-none">
                    </textarea>
                  </div>

                <div class="border-t border-gray-800 my-6"></div>

                <!-- Scheduled work -->
                <div>
                    <h3 class="flex items-center gap-2 text-sm text-gray-400">
                        <span class="material-icons text-base">calendar_today</span> Assigned Resources
                        <span class="ml-2 bg-gray-800 px-2 py-0.5 rounded-full text-xs">
                            {{ taskDetails?.resources?.length }}
                        </span>
                    </h3>

                    <div class="mt-4 bg-gray-900 rounded-md p-4 overflow-y-auto h-[46vh]">
                        <!-- Table Header -->
                        <div class="grid grid-cols-12 gap-4 items-center text-sm text-gray-400 border-b border-gray-700 pb-2">
                          <div class="col-span-2">Type</div>
                          <div class="col-span-3">Subject / ExamType</div>
                          <div class="col-span-5">Name</div>
                          <div class="col-span-2 text-center">Status</div>
                        </div>
                      
                        <!-- Loop through resources -->
                        <div *ngFor="let res of taskDetails?.resources"
                          class="mt-3 grid grid-cols-12 gap-4 items-center text-sm text-gray-200 hover:bg-gray-800 rounded-md p-2 transition">
                          
                          <!-- Type -->
                          <div class="col-span-2 font-medium">
                            {{ getResourceType(res.type) }}
                          </div>
                      
                          <!-- Subject or ExamType -->
                          <div class="col-span-3">
                            <ng-container *ngIf="res.type == '1'; else subjectBlock">
                              {{ res.subject || 'NA' }}
                            </ng-container>
                            <ng-template #subjectBlock>
                              {{ res.subject || 'NA' }}
                            </ng-template>
                          </div>
                      
                          <!-- Name with clickable navigation -->
                          <div class="col-span-5 flex items-center gap-3 cursor-pointer" (click)="NavigatetoExam(res)">
                            <div class="truncate">{{ res.name }}</div>
                          </div>
                      
                          <!-- Status with Icon -->
                          <div class="col-span-2 flex justify-center">
                            <ng-container [ngSwitch]="res.status">
                              <mat-icon *ngSwitchCase="3" class="text-green-500">check_circle</mat-icon>
                              <mat-icon *ngSwitchCase="2" class="text-yellow-500">autorenew</mat-icon>
                              <mat-icon *ngSwitchDefault class="text-gray-500">hourglass_empty</mat-icon>
                            </ng-container>
                          </div>
                        </div>
                      </div>
                      
                </div>


            </div>

            <!-- Right: Chat panel -->
            <!-- Right: Comment panel -->
            <div class="col-span-5 bg-gray-950 rounded-lg p-6 flex flex-col">
                <div class="comments-section" *ngIf="showComments">
                    <div class="section-header">
                        <span class="section-icon">ðŸ’¬</span>
                        <span class="section-title">Comments</span>
                    </div>

                    <div class="add-comment">
                        <div class="comment-avatar">
                            <span class="avatar-text">{{ getCurrentUserInitials() }}</span>
                        </div>
                        <div class="comment-input-wrapper">
                            <textarea [(ngModel)]="newComment" placeholder="Write a comment..." class="comment-textarea"
                                (keydown.enter)="addComment($event)"></textarea>
                            <div class="comment-actions" *ngIf="newComment?.trim()">
                                <button class="comment-btn save" (click)="addComment()">Save</button>
                                <button class="comment-btn cancel" (click)="cancelComment()">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div class="comments-list overflow-scroll max-h-[70vh]" (scroll)="onCommentsScroll($event)">
                        <div class="comment" *ngFor="let comment of currentTaskComments; trackBy: trackByCommentId">
                            <div class="comment-avatar">
                                <span class="avatar-text">
                                    {{ (comment.userName ? comment.userName[0] : '?') | uppercase }}

                                </span>
                            </div>
                            <div class="comment-content">
                                <div class="comment-header">
                                  <span class="comment-author">{{ comment.userName }}</span>
                                  <span class="comment-date">
                                    {{ comment.createdAt | date:'MMM d, y \'at\' h:mm a' }}
                                  </span>
                              
                                  <!-- Show menu only if current user is owner -->
                                  <div class="comment-menu" *ngIf="comment.userId == _userdetails?.Id">
                                    <button class="comment-menu-btn" (click)="toggleCommentMenu(comment.commentId)">â‹¯</button>
                                    <div class="comment-dropdown" *ngIf="comment.showMenu">
                                      <button (click)="toggleEditComment(comment)">Edit</button>
                                    </div>
                                  </div>
                                </div>
                              
                                <!-- Normal view -->
                                <div class="comment-text" *ngIf="!comment.isEditing">{{ comment.content }}</div>
                              
                                <!-- Edit mode -->
                                <div class="comment-text" *ngIf="comment.isEditing">
                                  <textarea
                                    [(ngModel)]="comment.editableContent"
                                    rows="3"
                                    class="mt-3 w-full text-sm text-white bg-gray-800 rounded-md p-2 outline-none">
                                  </textarea>
                              
                                  <div class="flex gap-2 mt-2">
                                    <button class="px-3 py-1 bg-blue-600 text-white rounded" (click)="saveComment(comment)">Save</button>
                                    <button class="px-3 py-1 bg-gray-500 text-white rounded" (click)="cancelEdit(comment)">Cancel</button>
                                  </div>
                                </div>
                              </div>
                              
                        </div>
                        <div *ngIf="isLoadingComments" class="text-xs text-gray-500">Loading...</div>
                    </div>

                </div>

            </div>


        </div>
    </div>
</div>